{% extends "base.html" %}
{% block content %}
    <div class="container-fluid py-4 min-vh-100 bg-light">
        {% if messages %}
            <div class="row justify-content-center">
                <div class="col-12 col-lg-8">
                    {% for message in messages %}
                        <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show shadow-sm border-0 rounded-4 mb-4"
                             role="alert">
                            <div class="d-flex align-items-center">
                                <i class="bi {% if message.tags == 'error' %}bi-exclamation-octagon-fill{% else %}bi-check-circle-fill{% endif %} me-2 fs-5"></i>
                                <div class="fw-bold">{{ message }}</div>
                            </div>
                            <button type="button"
                                    class="btn-close"
                                    data-bs-dismiss="alert"
                                    aria-label="Close"></button>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
        <div class="mb-4 d-flex align-items-center">
            <a href="javascript:history.back()"
               class="btn btn-outline-success border-2 rounded-circle d-inline-flex align-items-center justify-content-center me-3"
               style="width: 45px;
                      height: 45px"
               title="Wróć">
                <i class="bi bi-arrow-left fs-4"></i>
            </a>
            <div>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-1">
                        <li class="breadcrumb-item">
                            <a href="{% url 'fields' %}" class="text-decoration-none text-muted">Moje Pola</a>
                        </li>
                        <li class="breadcrumb-item active" aria-current="page">Szczegóły</li>
                    </ol>
                </nav>
                <div class="d-flex align-items-center gap-3">
                    <h2 class="fw-bold text-dark mb-0">{{ field.name|default:"Bez nazwy" }}</h2>
                    <button class="btn btn-outline-secondary border-2 rounded-circle d-inline-flex align-items-center justify-content-center"
                            style="width: 35px;
                                   height: 35px"
                            type="button"
                            data-bs-toggle="modal"
                            data-bs-target="#editFieldModal"
                            title="Edytuj dane pola">
                        <i class="bi bi-pencil-fill" style="font-size: 0.9rem;"></i>
                    </button>
                </div>
            </div>
        </div>
        <div class="row g-4">
            <div class="col-12 col-lg-8">
                <div class="card border-0 shadow-sm rounded-4 p-4 mb-4">
                    <h5 class="fw-bold mb-4">Podstawowe informacje</h5>
                    <div class="row g-3">
                        <div class="col-6 col-md-4">
                            <div class="p-3 border rounded-3 bg-light text-center text-md-start">
                                <small class="text-muted d-block text-uppercase fw-semibold"
                                       style="font-size: 0.7rem">Powierzchnia</small>
                                <span class="fs-4 fw-bold text-success">{{ field.area_size }}</span> <small class="text-muted">ha</small>
                            </div>
                        </div>
                        <div class="col-6 col-md-4">
                            <div class="p-3 border rounded-3 bg-light text-center text-md-start">
                                <small class="text-muted d-block text-uppercase fw-semibold"
                                       style="font-size: 0.7rem">Klasa ziemi</small>
                                <span class="fs-4 fw-bold text-dark">{{ field.soil_class|default:"---" }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card border-0 shadow-sm rounded-4 p-4 mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="fw-bold mb-0">Aktualne uprawy</h5>
                        <span class="badge bg-dark rounded-pill">Rok {{ field.current_year|default:"---" }}</span>
                    </div>
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light sticky-top" style="z-index: 1;">
                                <tr>
                                    <th>Gatunek</th>
                                    <th>Data siewu</th>
                                    <th class="text-end px-3">Akcje</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for cultivation in field.latest_cultivations %}
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="bg-success rounded-circle me-3"
                                                     style="width: 10px;
                                                            height: 10px"></div>
                                                <span class="fw-semibold text-dark">{{ cultivation.crop_type }}</span>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="text-muted">{{ cultivation.sowing_date|default:"Brak daty" }}</span>
                                        </td>
                                        <td class="text-end px-3">
                                            <div class="btn-group shadow-sm">
                                                <a href="{% url 'cultivation_detail' cultivation.id %}"
                                                   class="btn btn-sm btn-light border px-3"
                                                   title="Zobacz pole">
                                                    <i class="bi bi-eye me-1"></i> Szczegóły
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                {% empty %}
                                    <tr>
                                        <td colspan="3" class="text-center py-4 text-muted">Brak aktywnych upraw.</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card border-0 shadow-sm rounded-4 p-4">
                    <h5 class="fw-bold mb-4">Historia zabiegów</h5>
                    <div class="table-responsive" style="max-height: 320px; overflow-y: auto;">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light sticky-top" style="z-index: 1;">
                                <tr>
                                    <th>Zabieg</th>
                                    <th>Data</th>
                                    <th>Roślina</th>
                                    <th class="text-end px-3">Opis</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for treatment in field.treatments.all %}
                                    <tr>
                                        <td>
                                            <span class="badge {% if treatment.treatment_type == 'SW' %}bg-primary{% elif treatment.treatment_type == 'PT' %}bg-danger{% else %}bg-secondary{% endif %} rounded-pill">
                                                {{ treatment.get_treatment_type_display }}
                                            </span>
                                        </td>
                                        <td class="text-muted small">{{ treatment.date|date:"d.m.Y" }}</td>
                                        <td class="fw-semibold">{{ treatment.crop_type.name|default:"---" }}</td>
                                        <td class="text-end px-3">
                                            <small class="text-muted" title="{{ treatment.description }}">
                                                {{ treatment.description|truncatechars:30|default:"---" }}
                                            </small>
                                        </td>
                                    </tr>
                                {% empty %}
                                    <tr>
                                        <td colspan="4" class="text-center py-4 text-muted">Brak zarejestrowanych zabiegów.</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-12 col-lg-4">
                <div class="card border-0 bg-success text-white shadow-sm rounded-4 p-4 mb-4">
                    <h5 class="fw-bold mb-3">Szybkie akcje</h5>
                    <div class="d-grid gap-2">
                        <button class="btn btn-light fw-bold text-success rounded-3 border-0 w-100"
                                data-bs-toggle="modal"
                                data-bs-target="#addTreatmentModal">
                            <i class="bi bi-plus-lg me-2"></i>Dodaj zabieg
                        </button>
                        <button class="btn btn-outline-light rounded-3">
                            <i class="bi bi-calendar-event me-2"></i>Zaplanuj zbiór
                        </button>
                    </div>
                </div>
                <div class="card border-0 shadow-sm rounded-4 p-4 mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="fw-bold mb-0 text-dark">Historia upraw</h5>
                        <i class="bi bi-clock-history text-muted"></i>
                    </div>
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-sm table-hover align-middle mb-0">
                            <thead class="table-light sticky-top" style="z-index: 1;">
                                <tr class="small text-uppercase fw-bold text-muted">
                                    <th class="py-2">Rok</th>
                                    <th class="py-2">Gatunek</th>
                                    <th class="py-2 text-end">Plon</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for history in field.cultivations.all %}
                                    <tr>
                                        <td class="py-2 text-muted">{{ history.year }}</td>
                                        <td class="py-2 fw-semibold text-dark">{{ history.crop_type }}</td>
                                        <td class="py-2 text-end">
                                            <span class="badge bg-light text-dark border">
                                                {{ history.yield_amount|default:"0" }} <small>kg/ha</small>
                                            </span>
                                        </td>
                                    </tr>
                                {% empty %}
                                    <tr>
                                        <td colspan="3" class="text-center py-4 text-muted small">Brak danych historycznych.</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card border-0 shadow-sm rounded-4 p-4">
                    <h5 class="fw-bold mb-3 text-dark">Notatki</h5>
                    <p class="text-muted small">Wpisz uwagi dotyczące pH gleby lub specyficznych warunków.</p>
                    <form method="post">
                        {% csrf_token %}
                        <textarea class="form-control border-0 bg-light rounded-3 mb-3"
                                  rows="4"
                                  name="notes"
                                  placeholder="Np. Wapnowanie jesień 2025...">{{ field.notes|default:"" }}</textarea>
                        <button class="btn btn-dark btn-sm w-100 rounded-3 py-2">Zapisz notatkę</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade"
         id="editFieldModal"
         tabindex="-1"
         aria-labelledby="editFieldModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-header border-bottom-0 pt-4 px-4">
                    <h5 class="modal-title fw-bold" id="editFieldModalLabel">Edytuj dane pola</h5>
                    <button type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                            aria-label="Close"></button>
                </div>
                <form method="post" action="{% url 'update_field' field.id %}">
                    {% csrf_token %}
                    <div class="modal-body px-4">
                        <div class="mb-3">
                            <label class="form-label small fw-bold text-muted text-uppercase">Nazwa pola</label>
                            <input type="text"
                                   name="name"
                                   class="form-control rounded-3"
                                   value="{{ field.name }}"
                                   required>
                        </div>
                        <div class="row g-3">
                            <div class="col-6">
                                <label class="form-label small fw-bold text-muted text-uppercase">Powierzchnia (ha)</label>
                                <div class="input-group">
                                    <input type="number"
                                           step="0.01"
                                           name="area_size"
                                           class="form-control rounded-3"
                                           value="{{ field.area_size|stringformat:'.2f' }}"
                                           required>
                                </div>
                            </div>
                            <div class="col-6">
                                <label class="form-label small fw-bold text-muted text-uppercase">Klasa ziemi</label>
                                <select name="soil_class" class="form-select rounded-3">
                                    {% for value, label in field.SoilClass.choices %}
                                        <option value="{{ value }}"
                                                {% if field.soil_class == value %}selected{% endif %}>
                                            {{ label }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer border-top-0 pb-4 px-4 pt-3">
                        <button type="button"
                                class="btn btn-light fw-bold rounded-3"
                                data-bs-dismiss="modal">Anuluj</button>
                        <button type="submit" class="btn btn-success fw-bold px-4 rounded-3">Zapisz zmiany</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="modal fade"
         id="addTreatmentModal"
         tabindex="-1"
         aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-header border-bottom-0 pt-4 px-4">
                    <h5 class="modal-title fw-bold">Nowy zabieg dla: {{ field.name }}</h5>
                    <button type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                            aria-label="Close"></button>
                </div>
                <form method="post" action="{% url 'add_treatment' field.id %}">
                    {% csrf_token %}
                    <div class="modal-body px-4">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted text-uppercase">Rodzaj zabiegu</label>
                                {{ treatment_form.treatment_type }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted text-uppercase">Data wykonania</label>
                                {{ treatment_form.date }}
                            </div>
                            <div class="col-12" id="crop_type_wrapper" style="display: none;">
                                <div class="p-3 bg-light rounded-3 border border-success-subtle">
                                    <label class="form-label small fw-bold text-success text-uppercase">Roślina uprawna</label>
                                    {{ treatment_form.crop_type }}
                                </div>
                            </div>
                            <div class="col-12">
                                <label class="form-label small fw-bold text-muted text-uppercase">Opis / Uwagi</label>
                                {{ treatment_form.description }}
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer border-top-0 pb-4 px-4">
                        <button type="button" class="btn btn-light fw-bold" data-bs-dismiss="modal">Anuluj</button>
                        <button type="submit" class="btn btn-success fw-bold px-4">Zapisz zabieg</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script>
    document.getElementById('id_treatment_type').addEventListener('change', function() {
        const cropWrapper = document.getElementById('crop_type_wrapper');
        // "SW" to kod siewu z Twojego modelu
        if (this.value === 'SW') {
            cropWrapper.style.display = 'block';
        } else {
            cropWrapper.style.display = 'none';
        }
    });
    </script>
{% endblock content %}
