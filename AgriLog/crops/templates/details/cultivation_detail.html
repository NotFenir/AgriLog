{% extends 'base.html' %}
{% block content %}
    <div class="container-fluid px-4 py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="d-flex align-items-center">
                <a href="javascript:history.back()"
                   class="btn btn-outline-success border-2 rounded-circle d-inline-flex align-items-center justify-content-center me-3 shadow-sm"
                   style="width: 48px;
                          height: 48px;
                          transition: all 0.2s"
                   onmouseover="this.style.transform='translateX(-3px)'"
                   onmouseout="this.style.transform='translateX(0)'"
                   title="Wróć">
                    <i class="bi bi-arrow-left fs-4"></i>
                </a>
                <div>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-1" style="font-size: 0.85rem;">
                            <li class="breadcrumb-item">
                                <a href="{% url 'cultivations' %}"
                                   class="text-success text-decoration-none opacity-75">Historia upraw</a>
                            </li>
                            <li class="breadcrumb-item active fw-medium">{{ cultivation.crop_type.name }} ({{ cultivation.year }})</li>
                        </ol>
                    </nav>
                    <h2 class="fw-bold text-dark mb-0" style="letter-spacing: -0.5px;">
                        {{ cultivation.crop_type.name }}
                        <span class="text-muted fw-light mx-1">|</span>
                        <span class="text-muted fw-normal">{{ cultivation.year }}</span>
                    </h2>
                </div>
            </div>
            <div class="btn-group shadow-sm rounded-3">
                <button class="btn btn-white border bg-white fw-bold text-dark px-3"
                        data-bs-toggle="modal"
                        data-bs-target="#editCultivationModal">
                    <i class="bi bi-pencil-square me-2 text-success"></i>Edytuj
                </button>
                <button class="btn btn-white border bg-white text-danger fw-bold px-3">
                    <i class="bi bi-trash me-2"></i>Usuń
                </button>
            </div>
        </div>
        <div class="row g-4">
            <div class="col-lg-8">
                <div class="row g-4 mb-4">
                    <div class="col-md-4">
                        <div class="card border-0 shadow-sm rounded-4 p-4 text-center bg-white h-100">
                            <small class="text-uppercase fw-bold text-muted mb-2 d-block">Status uprawy</small>
                            {% if cultivation.status == 'PG' %}
                                <div class="display-6 mb-2 text-primary">
                                    <i class="bi bi-arrow-repeat-animation"></i>
                                </div>
                                <span class="badge bg-primary-subtle text-primary border border-primary-subtle rounded-pill py-2 px-4 fs-6">
                                    {{ cultivation.get_status_display }}
                                </span>
                            {% elif cultivation.status == 'CP' %}
                                <div class="display-6 mb-2 text-success">
                                    <i class="bi bi-check2-circle"></i>
                                </div>
                                <span class="badge bg-success-subtle text-success border border-success-subtle rounded-pill py-2 px-4 fs-6">
                                    {{ cultivation.get_status_display }}
                                </span>
                            {% else %}
                                <div class="display-6 mb-2 text-secondary">
                                    <i class="bi bi-x-circle"></i>
                                </div>
                                <span class="badge bg-secondary-subtle text-secondary border border-secondary-subtle rounded-pill py-2 px-4 fs-6">
                                    {{ cultivation.get_status_display }}
                                </span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-0 shadow-sm rounded-4 p-4 text-center bg-white h-100">
                            <small class="text-uppercase fw-bold text-muted mb-2 d-block">Data siewu</small>
                            <div class="display-6 mb-2 text-dark">
                                <i class="bi bi-calendar-event"></i>
                            </div>
                            <span class="fw-bold fs-5 text-dark">{{ cultivation.sowing_date|date:"d F Y"|default:"Nie podano" }}</span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-0 shadow-sm rounded-4 p-4 text-center bg-dark h-100">
                            <small class="text-uppercase fw-bold text-white-50 mb-2 d-block">Uzyskany plon</small>
                            <div class="display-6 mb-1 text-success fw-bold">{{ cultivation.yield_amount|floatformat:0 }}</div>
                            <span class="text-white fw-bold fs-4">kg</span>
                        </div>
                    </div>
                </div>
                <div class="card border-0 shadow-sm rounded-4 overflow-hidden mb-4">
                    <div class="card-body p-4">
                        <div class="d-flex align-items-center mb-3">
                            <div class="bg-dark-subtle p-2 rounded-3 me-3">
                                <i class="bi bi-pencil-fill text-dark"></i>
                            </div>
                            <div>
                                <h5 class="fw-bold mb-0 text-dark">Notatki i uwagi</h5>
                                <p class="text-muted small mb-0">Zapisz pH gleby, dawki nawozów lub warunki pogodowe.</p>
                            </div>
                        </div>
                        <form method="post">
                            {% csrf_token %}
                            <div class="position-relative mb-3">
                                <textarea class="form-control border-0 bg-light rounded-4 p-3 shadow-none"
                                          rows="5"
                                          name="notes"
                                          style="resize: none;
                                                 font-size: 0.95rem"
                                          onfocus="this.style.backgroundColor='#fff'; this.style.boxShadow='0 0 0 0.25rem rgba(25, 135, 84, 0.1)';"
                                          onblur="this.style.backgroundColor='#f8f9fa';"
                                          placeholder="Np. Wapnowanie wykonane przy wilgotnej glebie...">{{ cultivation.notes|default:"" }}</textarea>
                                {% if form.notes.errors %}
                                    <div class="text-danger small mt-2">{{ form.notes.errors }}</div>
                                {% endif %}
                            </div>
                            <button type="submit"
                                    class="btn btn-dark w-100 rounded-3 py-2 fw-bold d-flex align-items-center justify-content-center shadow-sm">
                                <i class="bi bi-check-lg me-2 text-success"></i> Zapisz notatkę
                            </button>
                        </form>
                        <div class="mt-3 text-center">
                            <small class="text-muted" style="font-size: 0.75rem;">
                                <i class="bi bi-clock-history me-1"></i> Ostatnia edycja: {{ cultivation.updated|date:"d.m.Y H:i" }}
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card border-0 shadow-sm rounded-4 p-4 mb-4">
                    <h5 class="fw-bold mb-3">Lokalizacja</h5>
                    <div class="d-flex align-items-center mb-3">
                        <div class="bg-success rounded-3 p-3 me-3 text-white">
                            <i class="bi bi-geo-alt fs-4"></i>
                        </div>
                        <div>
                            <h6 class="fw-bold mb-0 text-dark">{{ cultivation.field.name }}</h6>
                            <small class="text-muted">Powierzchnia: {{ cultivation.field.area_size }} ha</small>
                        </div>
                    </div>
                    <a href="{% url 'field_detail' cultivation.field.id %}"
                       class="btn btn-outline-success w-100 rounded-3 fw-bold">Zobacz pełne dane pola</a>
                </div>
                <div class="card border-0 shadow-sm rounded-4 p-4">
                    <h5 class="fw-bold mb-3">Charakterystyka gatunku</h5>
                    <div class="d-flex align-items-center">
                        <div class="bg-light rounded-circle p-3 me-3">
                            <i class="bi bi-flower1 text-success fs-4"></i>
                        </div>
                        <div>
                            <h6 class="fw-bold mb-0 text-dark">{{ cultivation.crop_type.name }}</h6>
                            <small class="text-muted">ID: #{{ cultivation.crop_type.id }}</small>
                        </div>
                    </div>
                    <hr class="my-3 text-muted opacity-25">
                    <div class="small">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Slug uprawy:</span>
                            <span class="fw-mono text-dark">{{ cultivation.slug|default:"---" }}</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Właściciel:</span>
                            <span class="text-dark">{{ cultivation.owner.get_full_name|default:cultivation.owner.username }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade"
         id="editCultivationModal"
         tabindex="-1"
         aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header border-0 pb-0">
                    <h5 class="fw-bold text-dark mt-2 ms-2">Edytuj dane uprawy</h5>
                    <button type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                            aria-label="Close"></button>
                </div>
                <form method="post" action="{% url 'update_cultivation' cultivation.id %}">
                    {% csrf_token %}
                    <div class="modal-body p-4">
                        <div class="mb-3">
                            <label class="form-label small fw-bold text-muted text-uppercase">Status uprawy</label>
                            {{ edit_form.status }}
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-bold text-muted text-uppercase">Data siewu</label>
                            {{ edit_form.sowing_date }}
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-bold text-muted text-uppercase">Uzyskany plon (kg)</label>
                            <div class="input-group">
                                {{ edit_form.yield_amount }}
                                <span class="input-group-text bg-light border-start-0 rounded-end-3">kg</span>
                            </div>
                            <div class="form-text">Wpisz 0, jeśli zbiory jeszcze nie nastąpiły.</div>
                        </div>
                    </div>
                    <div class="modal-footer border-0 pt-0 p-4">
                        <button type="button"
                                class="btn btn-light rounded-3 fw-bold px-4"
                                data-bs-dismiss="modal">Anuluj</button>
                        <button type="submit"
                                name="save_details"
                                class="btn btn-success rounded-3 fw-bold px-4">Zapisz zmiany</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock content %}
